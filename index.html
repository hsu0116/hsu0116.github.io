<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜¨ë¼ì¸ ìˆ«ì ì•¼êµ¬ ê²Œì„ (Baseball Number Game)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5',
                        'secondary': '#8b5cf6',
                        'success': '#10b981',
                        'error': '#ef4444',
                        'light-gray': '#f3f4f6',
                        'dark-text': '#1f2937'
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .game-card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 4px, 6px, 0.05);
        }
        .strike { color: #4f46e5; font-weight: 700; }
        .ball { color: #8b5cf6; font-weight: 700; }
        .out { color: #ef4444; font-weight: 700; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Game Card Container -->
    <div id="app" class="game-card bg-white w-full max-w-lg rounded-xl p-6 md:p-8 space-y-6">
        <h1 class="text-3xl font-extrabold text-primary text-center">âš¾ ìˆ«ì ì•¼êµ¬ ê²Œì„ âš¾</h1>
        <!-- 4ìë¦¬ë¡œ ë³€ê²½ëœ ì•ˆë‚´ ë¬¸êµ¬ -->
        <p class="text-center text-sm text-gray-500">4ìë¦¬ ë¹„ë°€ ìˆ«ìë¥¼ ë§ì¶°ë³´ì„¸ìš”! (ìˆ«ìëŠ” ì„œë¡œ ë‹¬ë¼ì•¼ í•©ë‹ˆë‹¤: ì˜ˆ. 1234)</p>

        <!-- Status and Game Info (User ID Display Added) -->
        <div class="bg-light-gray p-4 rounded-lg flex justify-between items-center text-dark-text text-sm flex-wrap gap-2">
            <span>ê²Œì„ ID: <span id="game-id-display" class="font-mono font-bold text-primary">ë¡œë”© ì¤‘...</span></span>
            <span>ë‚´ ID: <span id="user-id-display" class="font-mono text-xs text-gray-700">ì¸ì¦ ì¤‘...</span></span>
            <span id="game-status" class="font-bold text-primary">ì¤€ë¹„ ì¤‘</span>
        </div>

        <!-- Ready Section (Visible in WAITING state) -->
        <div id="ready-section" class="flex flex-col space-y-4">
            <div id="ready-status-container" class="space-y-2">
                <div id="ready-status-display" class="text-center text-sm font-medium text-purple-600">ì°¸ê°€ì ì¤€ë¹„ ìƒíƒœ: 0/2ëª…</div>
                <!-- ì¤€ë¹„ ì™„ë£Œëœ ì‚¬ìš©ì ID ëª©ë¡ì„ í‘œì‹œí•˜ëŠ” ê³³ -->
                <div id="ready-users-list" class="text-center text-xs text-gray-500 italic min-h-[1.5em]">ì¸ì¦ ì¤‘...</div>
            </div>
            
            <button id="ready-button" onclick="handleReady()"
                    class="w-full bg-secondary text-white py-3 rounded-lg font-bold text-lg hover:bg-purple-600 transition-colors shadow-lg shadow-secondary/50 disabled:bg-gray-400 disabled:shadow-none"
                    disabled>
                ì¸ì¦ ì¤‘...
            </button>

            <!-- ìˆ˜ë™ ê²Œì„ ì‹œì‘ ë²„íŠ¼ ì¶”ê°€ -->
            <button id="manual-start-button" onclick="handleManualStart()"
                    class="w-full bg-success text-white py-3 rounded-lg font-bold text-lg hover:bg-green-600 transition-colors shadow-lg shadow-success/50 disabled:bg-gray-400 disabled:shadow-none hidden">
                2ëª… ì´ìƒ ì¤€ë¹„ ì™„ë£Œ! ê²Œì„ ì‹œì‘
            </button>
            
            <!-- ìƒˆ ê²Œì„ ì‹œì‘ ë²„íŠ¼ì€ OVER ìƒíƒœì¼ ë•Œë§Œ í‘œì‹œë¨ -->
            <button id="new-game-button" onclick="startNewGame()"
                    class="w-full bg-secondary text-white py-2 rounded-lg font-medium text-sm hover:bg-purple-600 transition-colors hidden">
                ìƒˆ ê²Œì„ ì‹œì‘
            </button>
        </div>


        <!-- Guess Input and Button (Visible in PLAYING state) -->
        <div id="input-section" class="flex flex-col space-y-4 hidden">
            <!-- maxlength=4 ë¡œ ë³€ê²½ -->
            <input type="text" id="guess-input" maxlength="4"
                   class="w-full px-4 py-3 border-2 border-primary rounded-lg text-lg font-mono text-center focus:outline-none focus:ring-2 focus:ring-secondary"
                   placeholder="4ìë¦¬ ìˆ«ì ì…ë ¥ (ì˜ˆ: 1234)" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 4);">
            <button id="guess-button" onclick="handleGuess()"
                    class="w-full bg-primary text-white py-3 rounded-lg font-bold text-lg hover:bg-indigo-600 transition-colors shadow-lg shadow-primary/50 disabled:bg-gray-400 disabled:shadow-none"
                    disabled>
                ì¶”ì¸¡í•˜ê¸° (Guess)
            </button>
            <p id="error-message" class="text-error text-sm text-center font-medium hidden">ìœ íš¨í•˜ì§€ ì•Šì€ ì…ë ¥ì…ë‹ˆë‹¤.</p>
        </div>

        <!-- Game History -->
        <div class="space-y-3">
            <h2 class="text-xl font-bold text-dark-text border-b pb-1">ê¸°ë¡ (History)</h2>
            <div id="history-container" class="max-h-60 overflow-y-auto bg-white rounded-lg border">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-light-gray sticky top-0">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/5">#</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/5">ì¶”ì¸¡ (Guess)</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/5">ê²°ê³¼ (Result)</th>
                        </tr>
                    </thead>
                    <tbody id="history-body" class="bg-white divide-y divide-gray-200">
                        <!-- History rows will be inserted here -->
                    </tbody>
                </table>
                <p id="no-history" class="p-4 text-center text-gray-400 text-sm">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        </div>

        <!-- Game Over Modal (Hidden by default) -->
        <div id="game-over-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl p-8 text-center space-y-4 w-full max-w-sm">
                <h3 class="text-3xl font-extrabold text-success">ğŸ‰ ê²Œì„ ìŠ¹ë¦¬! ğŸ‰</h3>
                <p class="text-lg text-dark-text">ë¹„ë°€ ìˆ«ìëŠ” <span id="final-code" class="font-mono text-primary font-bold"></span> ì˜€ìŠµë‹ˆë‹¤!</p>
                <p class="text-sm text-gray-600">ì´ <span id="final-tries" class="font-bold"></span>ë²ˆì˜ ì‹œë„ë§Œì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤.</p>
                <!-- ìƒˆ ê²Œì„ ì‹œì‘ ë²„íŠ¼ì„ ëª¨ë‹¬ ë‚´ì—ì„œë„ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ìˆ˜ì • -->
                <button onclick="hideGameOverModal(); startNewGame();"
                        class="mt-4 w-full bg-secondary text-white py-3 rounded-lg font-bold hover:bg-purple-600 transition-colors">
                    ìƒˆ ê²Œì„ ì‹œì‘í•˜ê¸°
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, serverTimestamp, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Setup and Global Variables
        setLogLevel('Debug');
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const __initial_auth_token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const __app_id = typeof __app_id !== 'undefined' ? __app_id : 'baseball-default-app';

        let db, auth;
        let userId = null;
        let isAuthReady = false;
        let gameListener = null;

        // Game Constants
        const NUM_DIGITS = 4; // 4ìë¦¬ë¡œ ë³€ê²½
        const MIN_PLAYERS = 2; // ìµœì†Œ ì°¸ê°€ì ìˆ˜ (ì—¬ìì¹œêµ¬ì™€ ë‘˜ì´ì„œ)
        const GAME_PATH =
