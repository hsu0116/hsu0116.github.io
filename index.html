<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>⚾️ 2인 숫자 야구 - 시작</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#2c3e50',
                        'secondary': '#3498db',
                        'accent': '#2ecc71',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4 font-sans">

    <div id="app-container" class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md space-y-6">
        <h1 class="text-3xl font-bold text-center text-primary">
            ⚾️ 2인 숫자 야구
        </h1>
        <p class="text-center text-gray-500 mb-6">
            닉네임을 설정하고 게임에 접속하세요.
        </p>

        <!-- 닉네임 입력 -->
        <div class="space-y-4">
            <div>
                <label for="player-nickname" class="block text-sm font-medium text-gray-700 mb-1">내 닉네임</label>
                <input type="text" id="player-nickname" placeholder="닉네임을 입력하세요"
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-secondary focus:border-secondary transition duration-150">
            </div>
        </div>

        <!-- 상태 메시지 및 버튼 -->
        <div id="status-message" class="text-center text-sm font-semibold text-blue-600">
            <span id="auth-status">데이터베이스 연결 중...</span>
        </div>

        <button id="start-game-btn" disabled
                class="w-full py-3 px-4 bg-secondary text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 disabled:bg-gray-400">
            게임 시작 / 방 찾기
        </button>
        
        <p class="text-xs text-center text-gray-400 pt-4">
            내 ID: <span id="user-id-display" class="font-mono text-gray-600">불러오는 중</span>
        </p>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, query, where, getDocs, collection, onSnapshot, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 전역 변수 초기화
        let db;
        let auth;
        let userId = null;
        let appId = null;

        const authStatusEl = document.getElementById('auth-status');
        const startButton = document.getElementById('start-game-btn');
        const nicknameInput = document.getElementById('player-nickname');
        const userIdDisplay = document.getElementById('user-id-display');

        // Firestore 컬렉션 경로 (모두가 접근 가능한 공개 데이터 경로 사용)
        const getGameCollectionRef = () => collection(db, `artifacts/${appId}/public/data/number_baseball_games`);
        
        // --- 헬퍼 함수 ---

        // 1. Firebase 초기화 및 인증
        async function initFirebase() {
            try {
                // 캔버스 환경에서 제공되는 전역 변수 사용
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                if (!firebaseConfig.apiKey) {
                    throw new Error("Firebase configuration is missing.");
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                authStatusEl.textContent = "사용자 인증 중...";

                // 인증 토큰을 사용하여 로그인 시도 (캔버스 환경)
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    // 토큰이 없으면 익명으로 로그인 (일반 웹 환경)
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        authStatusEl.textContent = "인증 완료. 닉네임을 입력해주세요.";
                        startButton.disabled = false;
                        
                        // 이전에 저장된 닉네임 불러오기
                        const savedNickname = localStorage.getItem('playerNickname');
                        if (savedNickname) {
                            nicknameInput.value = savedNickname;
                        }
                    } else {
                        authStatusEl.textContent = "인증 실패.";
                    }
                });

            } catch (error) {
                console.error("Firebase 초기화 또는 인증 오류:", error);
                authStatusEl.textContent = `오류: ${error.message}`;
            }
        }

        // 2. 게임 시작/방 접속 처리
        async function handleGameStart() {
            if (!userId) {
                alert("사용자 인증이 완료되지 않았습니다. 잠시 후 다시 시도해 주세요.");
                return;
            }

            const nickname = nicknameInput.value.trim();
            if (!nickname) {
                alert("닉네임을 입력해 주세요.");
                return;
            }
            
            // 닉네임을 로컬 저장소에 저장
            localStorage.setItem('playerNickname', nickname);

            startButton.disabled = true;
            authStatusEl.textContent = "게임 방을 찾는 중...";

            try {
                // 1. WAITING 상태인 방 찾기 (Player 2가 들어올 수 있는 방)
                const q = query(getGameCollectionRef(), 
                    where("status", "==", "WAITING"),
                    where("player2_uid", "==", null) // player2가 없는 방만 찾기
                );

                const querySnapshot = await getDocs(q);
                let gameId = null;

                if (!querySnapshot.empty) {
                    // A. 대기 중인 방이 있으면, Player 2로 참여
                    const waitingDoc = querySnapshot.docs[0];
                    gameId = waitingDoc.id;
                    
                    await runTransaction(db, async (transaction) => {
                        const docRef = doc(getGameCollectionRef(), gameId);
                        const freshDoc = await transaction.get(docRef);

                        // 다시 한번 Player 2가 비어있는지 확인
                        if (freshDoc.exists() && freshDoc.data().player2_uid === null) {
                            transaction.update(docRef, {
                                player2_uid: userId,
                                player2_nickname: nickname,
                                status: "SETUP" // 게임 세팅 단계로 전환
                            });
                        } else {
                            // 이미 다른 사람이 참여했으므로 새로운 방 생성
                            gameId = await createNewGame(nickname);
                        }
                    });

                    if (gameId) {
                         authStatusEl.textContent = `게임 참가 성공! (ID: ${gameId}). 게임 화면으로 이동합니다.`;
                    }
                } else {
                    // B. 대기 중인 방이 없으면, Player 1로 새로운 방 생성
                    gameId = await createNewGame(nickname);
                    authStatusEl.textContent = `새로운 게임 방 생성 완료 (ID: ${gameId}). 상대방을 기다리는 중...`;
                }

                if (gameId) {
                    // 게임 ID를 로컬에 저장하고, 실제 게임 화면으로 이동합니다.
                    localStorage.setItem('gameId', gameId);
                    window.location.href = 'game.html'; 
                }

            } catch (error) {
                console.error("게임 시작/접속 오류:", error);
                authStatusEl.textContent = `게임 접속 오류: ${error.message}`;
                startButton.disabled = false;
            }
        }

        // 3. 새로운 게임 방 생성
        async function createNewGame(nickname) {
            const gameRef = doc(getGameCollectionRef()); // Firestore가 새 ID를 자동 생성
            const gameId = gameRef.id;

            await setDoc(gameRef, {
                gameId: gameId,
                status: "WAITING", // 대기 중
                createdAt: new Date().getTime(),
                player1_uid: userId,
                player1_nickname: nickname,
                player2_uid: null, // 상대방 대기
                player2_nickname: null,
                player1_secret: null,
                player2_secret: null,
                turn: null,
                logs: []
            });
            return gameId;
        }

        // 이벤트 리스너 연결
        startButton.addEventListener('click', handleGameStart);

        // 앱 시작
        initFirebase();

    </script>
</body>
</html>
