<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš¾ï¸ 2ì¸ ìˆ«ì ì•¼êµ¬ - ì‹¤ì‹œê°„ í”Œë ˆì´</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#2c3e50',
                        'secondary': '#3498db',
                        'accent': '#2ecc71',
                        'error': '#e74c3c',
                        'strike': '#2c3e50',
                        'ball': '#f39c12'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 min-h-screen p-4 font-sans">

    <div id="game-container" class="max-w-3xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-2xl space-y-6">
        <h1 class="text-3xl font-bold text-center text-primary">
            âš¾ï¸ 2ì¸ ìˆ«ì ì•¼êµ¬ (ì‹¤ì‹œê°„ ëª¨ë“œ)
        </h1>
        <div class="text-center text-sm text-gray-500 border-b pb-4">
            <span id="player-info" class="font-medium text-secondary"></span> ë‹˜ | 
            <span id="role-info" class="font-bold"></span> | 
            ê²Œì„ ID: <span id="game-id-display" class="font-mono text-base font-semibold text-gray-800 bg-yellow-100 px-2 py-1 rounded-md"></span>
        </div>

        <!-- ê²Œì„ ìƒíƒœ ë° ì •ë³´ -->
        <div id="game-status-box" class="p-4 rounded-lg bg-blue-50 border border-blue-200 text-center">
            <p id="match-status" class="font-bold text-blue-800">ê²Œì„ ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘...</p>
        </div>
        
        <!-- ë¹„ë°€ ìˆ«ì ì„¤ì • ì˜ì—­ -->
        <div id="secret-setup-area" class="space-y-4 hidden">
            <h2 class="text-xl font-semibold text-primary">ë‚˜ì˜ ë¹„ë°€ ìˆ«ì ì„¤ì • (4ìë¦¬, ì¤‘ë³µ ì—†ì´)</h2>
            <div class="flex space-x-2">
                <input type="text" id="secret-number-input" maxlength="4" placeholder="ì˜ˆ: 1478"
                       class="flex-grow p-3 border border-gray-300 rounded-lg text-lg text-center">
                <button id="set-secret-btn" disabled class="bg-accent text-white py-3 px-6 rounded-lg font-bold hover:bg-green-600 transition disabled:bg-gray-400">
                    ìˆ«ì í™•ì •
                </button>
            </div>
            <p id="secret-error" class="text-error text-sm hidden">4ìë¦¬, ì¤‘ë³µ ì—†ëŠ” ìˆ«ìë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</p>
        </div>

        <!-- ìƒëŒ€ë°© ëŒ€ê¸° ì•ˆë‚´ ì˜ì—­ -->
        <div id="opponent-wait-area" class="space-y-4 hidden border-t pt-4 p-4 bg-yellow-50 rounded-lg shadow-inner">
            <h2 id="opponent-wait-title" class="text-xl font-semibold text-primary">ìƒëŒ€ë°© ëŒ€ê¸° ì¤‘...</h2>
            <p id="opponent-wait-status" class="text-gray-600 text-sm">
                ìƒëŒ€ë°©ì´ ê²Œì„ì— ì ‘ì†í•˜ì—¬ ë¹„ë°€ ìˆ«ìë¥¼ ì„¤ì •í•˜ê¸°ë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.
            </p>
        </div>

        <!-- ê²Œì„ ë¡œê·¸ ì˜ì—­ -->
        <div id="game-log-area" class="space-y-3 pt-6 border-t mt-6">
            <h2 class="text-xl font-semibold text-primary">ê²Œì„ ë¡œê·¸</h2>
            <div id="logs" class="bg-gray-50 h-64 overflow-y-auto p-4 rounded-lg border border-gray-200 text-sm space-y-2">
                <!-- ê²Œì„ ê¸°ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
        </div>

        <!-- ì¶”ì¸¡ ì…ë ¥ ì˜ì—­ (ê²Œì„ ì‹œì‘ í›„ í™œì„±í™”) -->
        <div id="guess-input-area" class="space-y-4 pt-4 border-t hidden">
            <h2 class="text-xl font-semibold text-primary">ìƒëŒ€ë°© ìˆ«ì ì¶”ì¸¡í•˜ê¸°</h2>
            <div class="flex space-x-2">
                <input type="text" id="guess-input" maxlength="4" placeholder="4ìë¦¬ ìˆ«ì ì…ë ¥" disabled
                       class="flex-grow p-3 border border-gray-300 rounded-lg text-lg text-center bg-white disabled:bg-gray-200">
                <button id="submit-guess-btn" disabled
                        class="bg-secondary text-white py-3 px-6 rounded-lg font-bold hover:bg-blue-700 transition disabled:bg-gray-400">
                    ì¶”ì¸¡ ì‹œë„
                </button>
            </div>
            <p id="guess-error" class="text-error text-sm hidden">ì¶”ì¸¡ ìˆ«ìê°€ ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ì§€ê¸ˆì€ ìƒëŒ€ë°© ì°¨ë¡€ì…ë‹ˆë‹¤.</p>
        </div>
         <button id="back-to-lobby-btn" 
                class="w-full py-2 px-4 bg-gray-300 text-gray-800 font-bold rounded-lg hover:bg-gray-400 transition duration-300 mt-4">
            ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸°
        </button>
    </div>

    <!-- Firebase ë° ê²Œì„ ìŠ¤í¬ë¦½íŠ¸ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, updateDoc, onSnapshot, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        
        // --- ìº”ë²„ìŠ¤ í™˜ê²½ ë³€ìˆ˜ ì‚¬ìš© ë° ì•ˆì „í•œ íŒŒì‹± ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let firebaseConfig = null;
        try {
             // __firebase_config ë³€ìˆ˜ê°€ ë¬¸ìì—´ì´ë©° ë¹„ì–´ìˆì§€ ì•Šì€ì§€ í™•ì¸ í›„ JSON.parse ì‹¤í–‰
            if (typeof __firebase_config !== 'undefined' && __firebase_config && typeof __firebase_config === 'string') {
                firebaseConfig = JSON.parse(__firebase_config);
            }
        } catch (e) {
            console.error("Failed to parse __firebase_config:", e);
        }
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId;
        let gameData = {};
        let unsubscribe = null; // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ í•´ì œìš© ë³€ìˆ˜

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ê²Œì„ ì •ë³´ ë¡œë“œ
        const gameId = localStorage.getItem('gameId');
        const playerNickname = localStorage.getItem('playerNickname');
        const myRole = localStorage.getItem('myRole'); // 'P1' ë˜ëŠ” 'P2'

        const DIGIT_COUNT = 4;

        // --- DOM ìš”ì†Œ ---
        const gameIdDisplay = document.getElementById('game-id-display');
        const playerInfoEl = document.getElementById('player-info');
        const roleInfoEl = document.getElementById('role-info');
        const matchStatusEl = document.getElementById('match-status');
        const secretSetupArea = document.getElementById('secret-setup-area');
        const secretInput = document.getElementById('secret-number-input');
        const setSecretBtn = document.getElementById('set-secret-btn');
        const secretErrorEl = document.getElementById('secret-error');
        const logsEl = document.getElementById('logs');
        const guessInput = document.getElementById('guess-input');
        const submitGuessBtn = document.getElementById('submit-guess-btn');
        const guessErrorEl = document.getElementById('guess-error');
        const backToLobbyBtn = document.getElementById('back-to-lobby-btn');
        const opponentWaitArea = document.getElementById('opponent-wait-area');
        const opponentWaitStatusEl = document.getElementById('opponent-wait-status');


        if (!gameId || !playerNickname || !myRole) {
            matchStatusEl.textContent = 'âŒ í•„ìˆ˜ ê²Œì„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë¡œë¹„ë¡œ ëŒì•„ê°€ì„¸ìš”.';
            matchStatusEl.className = 'font-bold text-error';
            console.error("Missing required game info. Redirecting to lobby.");
            // 2ì´ˆ í›„ ë¡œë¹„ë¡œ ì´ë™
            setTimeout(() => window.location.href = 'index.html', 2000);
            return;
        }

        gameIdDisplay.textContent = gameId;
        playerInfoEl.textContent = playerNickname;
        roleInfoEl.textContent = (myRole === 'P1' ? 'Player 1 (ì„ ê³µ)' : 'Player 2 (í›„ê³µ)');


        // --- Firebase ì´ˆê¸°í™” ë° ì¸ì¦ ---
        async function initializeFirebaseAndAuth() {
             try {
                // Firebase Config ìœ íš¨ì„± ê²€ì‚¬ ê°•í™”
                if (!firebaseConfig || !firebaseConfig.apiKey || !firebaseConfig.projectId) {
                    matchStatusEl.textContent = 'âŒ Firebase ì„¤ì • ì˜¤ë¥˜: API í‚¤ ë˜ëŠ” Project IDê°€ ì—†ìŠµë‹ˆë‹¤.';
                    matchStatusEl.classList.remove('text-blue-800');
                    matchStatusEl.classList.add('text-error');
                    return;
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 1. ì´ˆê¸° í† í°ì„ ì‚¬ìš©í•˜ì—¬ ë¡œê·¸ì¸ ì‹œë„ (ìº”ë²„ìŠ¤ í™˜ê²½)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // 2. í† í°ì´ ì—†ìœ¼ë©´ ìµëª… ë¡œê·¸ì¸ ì‹œë„ (ë¡œì»¬ í…ŒìŠ¤íŠ¸ í™˜ê²½)
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        // ì¸ì¦ ì™„ë£Œ í›„ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
                        setupRealtimeGameListener();
                    } else {
                        // ì‚¬ìš©ì ì¸ì¦ ì‹¤íŒ¨ ì²˜ë¦¬
                        matchStatusEl.textContent = 'âŒ ì¸ì¦ ì‹¤íŒ¨. ë¡œë¹„ë¡œ ëŒì•„ê°€ì„¸ìš”.';
                        matchStatusEl.classList.remove('text-blue-800');
                        matchStatusEl.classList.add('text-error');
                    }
                });

            } catch (error) {
                console.error("Firebase ì´ˆê¸°í™” ë° ì¸ì¦ ì˜¤ë¥˜:", error);
                matchStatusEl.textContent = `âŒ ì˜¤ë¥˜: ${error.message}`;
                matchStatusEl.classList.remove('text-blue-800');
                matchStatusEl.classList.add('text-error');
            }
        }
        
        // --- ì‹¤ì‹œê°„ ë°ì´í„° ë¦¬ìŠ¤ë„ˆ ì„¤ì • ---
        function setupRealtimeGameListener() {
            if (unsubscribe) {
                unsubscribe(); // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ í•´ì œ
            }

            // ì¸ì¦ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ê±°ë‚˜ ê²Œì„ IDê°€ ì—†ìœ¼ë©´ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì¤‘ë‹¨
            if (!userId || !gameId) return;

            const gameRef = doc(db, `artifacts/${appId}/public/data/games`, gameId);

            // ì‹¤ì‹œê°„ìœ¼ë¡œ ë°ì´í„° ë³€ê²½ ê°ì§€
            unsubscribe = onSnapshot(gameRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    gameData = docSnapshot.data();
                    updateGameUI(); // ë°ì´í„° ë³€ê²½ ì‹œ UI ì—…ë°ì´íŠ¸
                } else {
                    matchStatusEl.textContent = 'âŒ ê²Œì„ ë°ì´í„°ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë¡œë¹„ë¡œ ëŒì•„ê°€ì„¸ìš”.';
                    matchStatusEl.className = 'font-bold text-error';
                    console.error("Game document does not exist.");
                }
            }, (error) => {
                console.error("Firestore Snapshot Error:", error);
                matchStatusEl.textContent = `âŒ ì‹¤ì‹œê°„ ì—°ê²° ì˜¤ë¥˜: ${error.message}`;
                matchStatusEl.className = 'font-bold text-error';
            });
        }
        
        // --- ê²Œì„ ë¡œì§ í—¬í¼ í•¨ìˆ˜ ---

        // 4ìë¦¬, ì¤‘ë³µ ì—†ëŠ” ìˆ«ìì¸ì§€ í™•ì¸
        function isValidSecret(num) {
            if (!new RegExp(`^\\d{${DIGIT_COUNT}}$`).test(num)) return false; 
            const digits = num.split('');
            return new Set(digits).size === DIGIT_COUNT; 
        }

        // ìŠ¤íŠ¸ë¼ì´í¬, ë³¼, ì•„ì›ƒ íŒì • ë¡œì§
        function calculateResult(guess, target) {
            let strikes = 0;
            let balls = 0;

            if (!guess || !target || guess.length !== target.length) {
                return "Error"; 
            }

            for (let i = 0; i < DIGIT_COUNT; i++) {
                if (guess[i] === target[i]) {
                    strikes++;
                } else if (target.includes(guess[i])) {
                    balls++;
                }
            }

            if (strikes === 0 && balls === 0) {
                return "0S 0B (OUT)";
            } else if (strikes === DIGIT_COUNT) {
                return `${DIGIT_COUNT}S (HOMERUN!)`;
            } else {
                let result = '';
                if (strikes > 0) result += `${strikes}S`;
                if (balls > 0) {
                    if (result) result += ' ';
                    result += `${balls}B`;
                }
                return result.trim();
            }
        }
        
        // --- ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë° Firestore ì—…ë°ì´íŠ¸ ---

        // 1. ë¹„ë°€ ìˆ«ì í™•ì • í•¸ë“¤ëŸ¬ (Firestore ì—…ë°ì´íŠ¸)
        setSecretBtn.addEventListener('click', async () => {
            const secret = secretInput.value.trim();
            if (!isValidSecret(secret)) {
                secretErrorEl.textContent = `${DIGIT_COUNT}ìë¦¬, ì¤‘ë³µ ì—†ëŠ” ìˆ«ìë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.`;
                secretErrorEl.classList.remove('hidden');
                return;
            }
            
            const mySecretKey = myRole === 'P1' ? 'player1_secret' : 'player2_secret';
            const opponentSecretSet = myRole === 'P1' ? gameData.player2_secret : gameData.player1_secret;
            
            // ìƒëŒ€ë°©ì´ ì´ë¯¸ ìˆ«ìë¥¼ ì„¤ì •í–ˆê³ , ê·¸ ìˆ«ìê°€ ë‚´ê°€ ì„¤ì •í•˜ë ¤ëŠ” ìˆ«ìì™€ ê°™ìœ¼ë©´ ì•ˆ ë¨
            if (opponentSecretSet && opponentSecretSet === secret) {
                 secretErrorEl.textContent = `ìƒëŒ€ë°©ì˜ ë¹„ë°€ ìˆ«ìì™€ ë™ì¼í•œ ìˆ«ìë¥¼ ì„¤ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
                 secretErrorEl.classList.remove('hidden');
                 return;
            }

            secretErrorEl.classList.add('hidden');
            setSecretBtn.disabled = true;
            setSecretBtn.textContent = 'ì €ì¥ ì¤‘...';

            const gameRef = doc(db, `artifacts/${appId}/public/data/games`, gameId);
            let updateData = { [mySecretKey]: secret };

            // ë‚´ ë¹„ë°€ ìˆ«ì ì„¤ì • ì™„ë£Œ í›„, ìƒëŒ€ë°©ì˜ ë¹„ë°€ ìˆ«ìë„ ì„¤ì •ë˜ì—ˆë‹¤ë©´ ê²Œì„ ì‹œì‘ (í„´ì„ P1ìœ¼ë¡œ ì„¤ì •)
            if (opponentSecretSet !== null) {
                updateData.status = 'IN_PROGRESS';
                updateData.turn = 'P1'; 
            }
            
            try {
                await updateDoc(gameRef, updateData);
                // UIëŠ” onSnapshotì´ ì²˜ë¦¬í•  ê²ƒì„
            } catch (error) {
                // UIì— ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
                matchStatusEl.textContent = `âŒ ë¹„ë°€ ìˆ«ì ì„¤ì • ì‹¤íŒ¨: ${error.message}`;
                matchStatusEl.classList.remove('text-blue-800');
                matchStatusEl.classList.add('text-error');
                
                setSecretBtn.disabled = false;
                setSecretBtn.textContent = 'ìˆ«ì í™•ì •';
            }
        });


        // 2. ì¶”ì¸¡ ì œì¶œ í•¸ë“¤ëŸ¬ (Firestore ì—…ë°ì´íŠ¸)
        submitGuessBtn.addEventListener('click', async () => {
            const guess = guessInput.value.trim();
            if (!isValidSecret(guess)) {
                guessErrorEl.textContent = `4ìë¦¬, ì¤‘ë³µ ì—†ëŠ” ìˆ«ìë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.`;
                guessErrorEl.classList.remove('hidden');
                return;
            }
            if (gameData.turn !== myRole || gameData.status !== 'IN_PROGRESS') {
                guessErrorEl.textContent = `ì§€ê¸ˆì€ ${gameData.turn !== myRole ? 'ìƒëŒ€ë°©ì˜' : ''} ì°¨ë¡€ê°€ ì•„ë‹™ë‹ˆë‹¤.`;
                guessErrorEl.classList.remove('hidden');
                return;
            }
            
            submitGuessBtn.disabled = true;
            submitGuessBtn.textContent = 'íŒì • ì¤‘...';
            guessErrorEl.classList.add('hidden');

            const gameRef = doc(db, `artifacts/${appId}/public/data/games`, gameId);

            // íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•˜ì—¬ ì•ˆì „í•˜ê²Œ ë¡œê·¸ ê¸°ë¡ ë° í„´ ì „í™˜
            try {
                await runTransaction(db, async (transaction) => {
                    const gameDoc = await transaction.get(gameRef);
                    if (!gameDoc.exists()) throw new Error("ê²Œì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

                    const currentData = gameDoc.data();
                    
                    // ë§ˆì§€ë§‰ìœ¼ë¡œ í„´ì„ í•œ ë²ˆ ë” í™•ì¸ (íŠ¸ëœì­ì…˜ ë‚´)
                    if (currentData.turn !== myRole || currentData.status !== 'IN_PROGRESS') {
                         throw new Error("ì°¨ë¡€ê°€ ì•„ë‹ˆê±°ë‚˜ ê²Œì„ì´ ì§„í–‰ ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤.");
                    }
                    
                    const targetSecret = myRole === 'P1' ? currentData.player2_secret : currentData.player1_secret;
                    const result = calculateResult(guess, targetSecret);

                    const newLog = {
                        guesser: playerNickname,
                        guess: guess,
                        result: result,
                        timestamp: new Date().getTime(),
                        role: myRole
                    };
                    
                    // ë¡œê·¸ ë°°ì—´ì— ìƒˆ ë¡œê·¸ ì¶”ê°€
                    const newLogs = Array.isArray(currentData.logs) ? [...currentData.logs, newLog] : [newLog];
                    
                    const isWin = result.includes(`${DIGIT_COUNT}S`);
                    let updateData = { logs: newLogs };
                    
                    if (isWin) {
                        updateData.status = 'FINISHED';
                        updateData.winner_nickname = playerNickname;
                        updateData.turn = null;
                    } else {
                        updateData.turn = myRole === 'P1' ? 'P2' : 'P1';
                    }

                    transaction.update(gameRef, updateData);
                });
                
                guessInput.value = ''; // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            } catch (error) {
                // UIì— ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
                matchStatusEl.textContent = `âŒ ì¶”ì¸¡ ì œì¶œ ì‹¤íŒ¨: ${error.message}`;
                matchStatusEl.classList.remove('text-blue-800');
                matchStatusEl.classList.add('text-error');
            } finally {
                // UI ì—…ë°ì´íŠ¸ëŠ” onSnapshotì´ ì²˜ë¦¬í•˜ì§€ë§Œ, ë²„íŠ¼ ìƒíƒœëŠ” ì¬í™œì„±í™”
                submitGuessBtn.disabled = false; 
                submitGuessBtn.textContent = 'ì¶”ì¸¡ ì‹œë„';
            }
        });


        // --- UI ì—…ë°ì´íŠ¸ ë¡œì§ (í•µì‹¬) ---
        function updateGameUI() {
            // Player ì •ë³´ ì„¤ì •
            const mySecretSet = (myRole === 'P1' ? gameData.player1_secret : gameData.player2_secret) !== null;
            const opponentNickname = myRole === 'P1' ? gameData.player2_nickname : gameData.player1_nickname;
            
            // 1. ë§¤ì¹˜ ìƒíƒœ í‘œì‹œ ë° ì˜ì—­ ê°€ì‹œì„± ì œì–´
            const myTurn = gameData.turn === myRole;
            secretSetupArea.classList.add('hidden');
            guessInputArea.classList.add('hidden');
            opponentWaitArea.classList.add('hidden');

            matchStatusEl.classList.remove('text-error', 'text-yellow-800', 'text-accent', 'text-gray-800');


            if (gameData.status === 'WAITING') {
                matchStatusEl.classList.add('text-yellow-800');
                matchStatusEl.textContent = `ìƒëŒ€ë°© (${opponentNickname || 'ëŒ€ê¸° ì¤‘'})ì´ ì°¸ê°€í•˜ê¸°ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘ì…ë‹ˆë‹¤.`;
                opponentWaitArea.classList.remove('hidden');
                opponentWaitStatusEl.textContent = `ê²Œì„ ID: ${gameId}ë¥¼ ê³µìœ í•˜ì—¬ ìƒëŒ€ë°©ì„ ì´ˆëŒ€í•˜ì„¸ìš”.`;
            } else if (gameData.status === 'SETUP') {
                if (!mySecretSet) {
                    // ë‚´ ìˆ«ì ì„¤ì • í•„ìš”
                    matchStatusEl.classList.add('text-yellow-800');
                    matchStatusEl.textContent = 'ë‚˜ì˜ ë¹„ë°€ ìˆ«ìë¥¼ ì„¤ì •í•´ ì£¼ì„¸ìš”.';
                    secretSetupArea.classList.remove('hidden');
                    setSecretBtn.disabled = !isValidSecret(secretInput.value.trim()); 
                    setSecretBtn.textContent = 'ìˆ«ì í™•ì •';
                } else {
                    // ìƒëŒ€ë°© ìˆ«ì ì„¤ì • ëŒ€ê¸°
                    matchStatusEl.classList.add('text-gray-800');
                    matchStatusEl.textContent = `${opponentNickname}ë‹˜ì´ ë¹„ë°€ ìˆ«ìë¥¼ ì„¤ì •í•˜ê¸°ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘ì…ë‹ˆë‹¤.`;
                    opponentWaitArea.classList.remove('hidden');
                    opponentWaitStatusEl.textContent = `${opponentNickname}ë‹˜ì´ ìˆ«ìë¥¼ í™•ì •í•˜ë©´ ê²Œì„ì´ ìë™ìœ¼ë¡œ ì‹œì‘ë©ë‹ˆë‹¤.`;
                }
            } else if (gameData.status === 'IN_PROGRESS') {
                matchStatusEl.classList.add('text-accent');
                guessInputArea.classList.remove('hidden');

                if (myTurn) {
                    matchStatusEl.textContent = `ë‚´ ì°¨ë¡€ì…ë‹ˆë‹¤! ${opponentNickname}ì˜ ìˆ«ìë¥¼ ì¶”ì¸¡í•˜ì„¸ìš”.`;
                    guessInput.disabled = false;
                    guessInput.placeholder = "4ìë¦¬ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”";
                    submitGuessBtn.disabled = !isValidSecret(guessInput.value.trim()); 
                } else {
                    matchStatusEl.textContent = `${opponentNickname}ë‹˜ì˜ ì°¨ë¡€ì…ë‹ˆë‹¤. ì¶”ì¸¡ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...`;
                    guessInput.disabled = true;
                    guessInput.placeholder = `${opponentNickname}ì˜ ì¶”ì¸¡ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...`;
                    submitGuessBtn.disabled = true;
                }
            } else if (gameData.status === 'FINISHED') {
                matchStatusEl.classList.add('text-error');
                matchStatusEl.textContent = `ğŸ‰ ê²Œì„ ì¢…ë£Œ! ìŠ¹ë¦¬ì: ${gameData.winner_nickname} ğŸ‰`;
                guessInputArea.classList.add('hidden');
            }


            // 2. ê²Œì„ ë¡œê·¸ í‘œì‹œ
            logsEl.innerHTML = '';
            if (gameData.logs && gameData.logs.length > 0) {
                // ë¡œê·¸ë¥¼ íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ì¤€ìœ¼ë¡œ ì—­ìˆœ ì •ë ¬ (ìµœì‹  ë¡œê·¸ë¥¼ ìœ„ì— ë³´ì´ë„ë¡)
                const sortedLogs = [...gameData.logs].sort((a, b) => a.timestamp - b.timestamp);
                
                sortedLogs.forEach(log => {
                    const p = document.createElement('p');
                    p.className = 'border-b pb-1 text-gray-800';
                    
                    let resultColorClass = 'font-bold';
                    if (log.result.includes('HOMERUN')) {
                        resultColorClass = 'text-accent font-extrabold';
                    } else if (log.result.includes('S')) {
                        resultColorClass = 'text-strike font-bold';
                    } else if (log.result.includes('B')) {
                        resultColorClass = 'text-ball font-bold';
                    }

                    const isMine = log.role === myRole;
                    const nickname = isMine ? 'ë‚˜' : log.guesser;
                    
                    p.innerHTML = `<span class="font-semibold ${isMine ? 'text-secondary' : 'text-primary'}">${nickname}</span> ì‹œë„: ${log.guess} &rarr; <strong class="${resultColorClass}">${log.result}</strong>`;
                    logsEl.appendChild(p); // ì‹œê°„ ìˆœì„œëŒ€ë¡œ (ì•„ë˜ë¡œ ì¶”ê°€)
                });
                logsEl.scrollTop = logsEl.scrollHeight; // ìŠ¤í¬ë¡¤ì„ í•­ìƒ ì•„ë˜ë¡œ
            } else {
                logsEl.innerHTML = `<p class="text-gray-600">ì¶”ì¸¡ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ê²Œì„ì´ ì‹œì‘ë˜ê¸°ë¥¼ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</p>`;
            }
        }
        
        // --- ë¦¬ìŠ¤ë„ˆ ì—°ê²° ---
        secretInput.addEventListener('input', () => {
            setSecretBtn.disabled = !isValidSecret(secretInput.value.trim());
            secretErrorEl.classList.add('hidden');
        });

        guessInput.addEventListener('input', () => {
            if (!guessInput.disabled) {
                submitGuessBtn.disabled = !isValidSecret(guessInput.value.trim());
            }
            guessErrorEl.classList.add('hidden');
        });

        submitGuessBtn.addEventListener('click', () => {
             // ì œì¶œ í•¸ë“¤ëŸ¬ ë‚´ì—ì„œ ìœ íš¨ì„± ê²€ì‚¬ ë° í„´ í™•ì¸ì„ ë‹¤ì‹œ í•©ë‹ˆë‹¤.
             // ì´ ì½”ë“œëŠ” ì´ë¯¸ submitGuessBtn.addEventListener ë‚´ë¶€ì— ì •ì˜ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ì œê±°í•©ë‹ˆë‹¤.
        });

        backToLobbyBtn.addEventListener('click', () => {
             if (unsubscribe) unsubscribe(); // ë¦¬ìŠ¤ë„ˆ í•´ì œ
             // ê²Œì„ ID ë“± ì„¸ì…˜ ì •ë³´ë§Œ ì œê±°
             localStorage.removeItem('gameId');
             localStorage.removeItem('myRole');
             localStorage.removeItem('playerNickname'); // ë‹‰ë„¤ì„ë„ ì œê±°
             window.location.href = 'index.html';
        });

        // ì´ˆê¸°í™” ì‹œì‘
        initializeFirebaseAndAuth();
    </script>
</body>
</html>
